import { Meta } from "@storybook/blocks";

<Meta title="Monitoramento/Sistema de Alertas" />

# Sistema de Alertas de Performance

## Vis√£o Geral

O sistema de alertas permite monitorar m√©tricas cr√≠ticas de performance em tempo real e notificar equipes automaticamente quando thresholds s√£o ultrapassados. Suporta m√∫ltiplos canais de notifica√ß√£o incluindo Slack, email e webhooks gen√©ricos.

## Funcionalidades

### Alertas Autom√°ticos

- **M√©tricas Monitoradas**: CLS, INP, FCP, LCP, TTFB
- **Severidades**: Warning, Error, Critical
- **Cooldown**: Evita spam de notifica√ß√µes repetidas
- **Regras Configur√°veis**: Condi√ß√µes personaliz√°veis por m√©trica

### Canais de Notifica√ß√£o

#### Slack
```bash
# Configura√ß√£o via vari√°vel de ambiente
REACT_APP_SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK
```

**Exemplo de mensagem no Slack:**
```
üö® *Alerta de Performance CR√çTICO*

Layout inst√°vel detectado (0.300). Usu√°rios podem estar experimentando mudan√ßas visuais inesperadas.

‚Ä¢ M√©trica: CLS
‚Ä¢ Valor: 0.300
‚Ä¢ Timestamp: 15/12/2024 14:30:25
‚Ä¢ Severidade: critical
```

#### Email
```bash
# Configura√ß√£o via vari√°vel de ambiente
REACT_APP_ALERT_EMAIL_TO=dev-team@adsmagic.com
```

#### Webhook Gen√©rico
```bash
# Configura√ß√£o via vari√°vel de ambiente
REACT_APP_ALERT_WEBHOOK_URL=https://your-webhook-endpoint.com/alerts
```

**Payload enviado:**
```json
{
  "alert": {
    "id": "cls-critical-1734273025123",
    "ruleId": "cls-critical",
    "metric": {
      "name": "CLS",
      "value": 0.3,
      "rating": "poor",
      "timestamp": 1734273025123
    },
    "message": "Layout inst√°vel detectado (0.300)...",
    "severity": "critical",
    "timestamp": 1734273025123,
    "sent": true,
    "sentAt": 1734273025124
  },
  "timestamp": "2024-12-15T14:30:25.124Z"
}
```

## Regras Padr√£o

O sistema vem pr√©-configurado com regras otimizadas para m√©tricas cr√≠ticas:

| Regra | M√©trica | Condi√ß√£o | Threshold | Severidade | Cooldown |
|-------|---------|----------|-----------|------------|----------|
| CLS Cr√≠tico | CLS | > | 0.25 | Critical | 30min |
| INP Cr√≠tico | INP | > | 200ms | Critical | 15min |
| LCP Alerta | LCP | > | 2500ms | Warning | 60min |
| FCP Erro | FCP | > | 2000ms | Error | 45min |

## Configura√ß√£o via Interface

### Acessando a Configura√ß√£o

1. No Performance Dashboard, clique em "‚öôÔ∏è Configurar Alertas"
2. Interface modal permite criar/editar regras
3. Configura√ß√£o em tempo real

### Criando Nova Regra

```typescript
interface AlertRule {
  id: string;
  name: string;           // Nome descritivo da regra
  metric: string;         // CLS, INP, FCP, LCP, TTFB
  condition: 'gt' | 'lt' | 'eq';  // Maior que, menor que, igual
  threshold: number;      // Valor limite
  severity: 'warning' | 'error' | 'critical';
  channels: AlertChannel[]; // Canais de notifica√ß√£o
  enabled: boolean;       // Regra ativa/inativa
  cooldownMinutes: number; // Minutos entre alertas
}
```

### Canais Dispon√≠veis

```typescript
interface AlertChannel {
  type: 'email' | 'slack' | 'webhook';
  config: {
    webhookUrl?: string;   // Para Slack/webhook
    emailTo?: string;      // Para email
    slackChannel?: string; // Canal do Slack (opcional)
  };
}
```

## Integra√ß√£o T√©cnica

### Hook de Monitoramento

```typescript
// Em usePerformanceMonitoring.ts
useWebVitals((metric) => {
  // ... outras opera√ß√µes

  // Verificar alertas configurados
  if (metric.rating === 'poor') {
    alertService.checkMetrics([metric]);
  }
});
```

### Servi√ßo de Alertas

```typescript
import { alertService } from '../services/alertService';

// Verificar m√©tricas manualmente
const alerts = await alertService.checkMetrics(metrics);

// Configurar via vari√°veis de ambiente
alertService.configureFromEnv();

// Gerenciar regras
alertService.addRule(newRule);
alertService.updateRule(ruleId, updates);
alertService.removeRule(ruleId);
```

## Boas Pr√°ticas

### Configura√ß√£o de Thresholds

- **CLS > 0.25**: Impacto cr√≠tico na experi√™ncia visual
- **INP > 200ms**: Intera√ß√µes lentas afetam usabilidade
- **LCP > 2500ms**: Conte√∫do principal demora para carregar
- **FCP > 2000ms**: Primeira impress√£o ruim

### Cooldown Recomendado

- **Cr√≠tico**: 15-30 minutos (a√ß√£o imediata necess√°ria)
- **Erro**: 30-60 minutos (a√ß√£o priorit√°ria)
- **Warning**: 60-120 minutos (monitoramento cont√≠nuo)

### Canais por Severidade

- **Critical**: Slack + Email (notifica√ß√£o imediata)
- **Error**: Slack (time t√©cnico)
- **Warning**: Webhook (sistema de monitoramento)

## Monitoramento e Logs

### Logs de Alertas

```typescript
// Alertas enviados s√£o logados no console
console.log('üìß Email alert to dev-team@adsmagic.com:', alert.message);

// Em produ√ß√£o, considere centralizar logs
// - ELK Stack
// - Datadog
// - New Relic
```

### M√©tricas de Alertas

- **Taxa de Disparo**: Quantidade de alertas por per√≠odo
- **Tempo de Resposta**: M√©dia entre detec√ß√£o e a√ß√£o
- **Precis√£o**: Percentual de alertas acion√°veis

## Troubleshooting

### Alertas N√£o Disparando

1. Verificar se regras est√£o habilitadas
2. Confirmar thresholds apropriados
3. Checar configura√ß√£o de canais
4. Validar vari√°veis de ambiente

### Spam de Alertas

1. Aumentar cooldown
2. Refinar condi√ß√µes de trigger
3. Implementar l√≥gica de agrupamento
4. Usar severidades apropriadas

### Canais N√£o Funcionando

1. **Slack**: Validar webhook URL
2. **Email**: Verificar configura√ß√£o SMTP
3. **Webhook**: Testar endpoint manualmente

## Extens√µes Futuras

### Poss√≠veis Melhorias

- **Machine Learning**: Detec√ß√£o autom√°tica de anomalias
- **Agrupamento**: Alertas agregados por per√≠odo
- **Escalonamento**: Notifica√ß√µes progressivas
- **Integra√ß√µes**: Teams, Discord, PagerDuty
- **Dashboards**: Visualiza√ß√£o de alertas hist√≥ricos